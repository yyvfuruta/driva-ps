apiVersion: v1
kind: ConfigMap
metadata:
  name: app
data:
  apiPort: "8080"

  dbHost: postgres-headless.default.svc
  dbPort: "5432"
  dbName: app
  dbSSLMode: disable

  rabbitmqHost: rabbitmq-headless.default.svc
  rabbitmqPort: "5672"

  redisHost: redis.default.svc
  redisPort: "6379"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: api-migrations
data:
  001_initial_schema.sql: |
    CREATE TABLE IF NOT EXISTS orders (
        id uuid PRIMARY KEY,
        customer_id TEXT NOT NULL,
        status TEXT NOT NULL,
        total_amount NUMERIC(12, 2),
        created_at TIMESTAMP NOT NULL DEFAULT NOW(),
        updated_at TIMESTAMP NOT NULL DEFAULT NOW()
    );

    CREATE TABLE IF NOT EXISTS order_items (
        id SERIAL PRIMARY KEY,
        order_id uuid NOT NULL REFERENCES orders(id),
        sku TEXT NOT NULL,
        qty INT NOT NULL
    );

    CREATE TABLE IF NOT EXISTS order_enrichments (
        id SERIAL PRIMARY KEY,
        order_id uuid NOT NULL REFERENCES orders(id),
        data JSONB,
        created_at TIMESTAMP NOT NULL DEFAULT NOW()
    );

    CREATE TABLE IF NOT EXISTS idempotency_keys (
        key TEXT PRIMARY KEY,
        order_id uuid NOT NULL,
        created_at TIMESTAMP NOT NULL DEFAULT NOW()
    );
